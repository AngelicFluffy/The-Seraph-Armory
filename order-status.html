<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Status - The Seraph Armory</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/JK0Qm5X.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="google-sheets-config.js"></script>
  <script>
    // Ensure config is available for order status page
    window.GOOGLE_SHEETS_CONFIG = {
      SHEET_ID: '1nOJrh5M9wsw4cIz3MRBSfOKrfFIdOGcVwPwMKpo9u-s',
      APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbz8jN8tITpiH1d3Ow-pIgqHo_mpw9Yrtg3VupVYmbowDfloInM6WPHIj5r-plzprh95qw/exec',
      RANGE: 'Orders!A:N'
    };
  </script>
  <style>
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    html {
      scroll-behavior: smooth;
    }

    .professional-card {
      background: linear-gradient(145deg, #1a1a1a 0%, #1f1f1f 100%);
      border: 1px solid rgba(211, 175, 55, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .professional-card:hover {
      border-color: rgba(211, 175, 55, 0.5);
      box-shadow: 0 8px 32px rgba(211, 175, 55, 0.1);
      transform: translateY(-2px);
    }

    .professional-button {
      background: linear-gradient(135deg, #D3AF37 0%, #b8941f 100%);
      border: none;
      color: #141414;
      font-weight: 500;
      letter-spacing: 0.025em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(211, 175, 55, 0.3);
    }

    .professional-button:hover {
      background: linear-gradient(135deg, #b8941f 0%, #a0821b 100%);
      box-shadow: 0 6px 20px rgba(211, 175, 55, 0.4);
      transform: translateY(-1px);
    }
  </style>
</head>
<body class="text-white font-sans" style="background-color: #141414;">

  <!-- Header -->
  <header class="py-8 px-4 border-b border-opacity-30 backdrop-blur-md" style="background-color: rgba(20, 20, 20, 0.95); border-color: #D3AF37;">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <a href="index.html" class="flex items-center space-x-3 text-2xl font-bold hover:opacity-80 transition-all duration-300 group" style="color: #D3AF37;">
          <svg class="w-6 h-6 transition-transform duration-300 group-hover:-translate-x-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
          </svg>
          <span>The Seraph Armory</span>
        </a>
      </div>
      <div class="professional-card px-4 py-2">
        <div class="text-sm font-semibold text-gray-300">
          <span style="color: #D3AF37;">Game Version:</span> 4.3.2
        </div>
      </div>
    </div>
  </header>

  <!-- Order Status Section -->
  <section class="py-20 px-4" style="background-color: #141414;">
    <div class="max-w-5xl mx-auto">
      <div class="text-center mb-16">
        <h1 class="text-5xl font-bold mb-6" style="color: #D3AF37;">Order Tracking</h1>
        <p class="text-xl text-gray-300 font-light">Track your Seraph Armory orders</p>
      </div>

      <!-- Order Lookup Form -->
      <div class="professional-card p-10 rounded-2xl mb-12 shadow-2xl">
        <div class="text-center mb-8">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #D3AF37 0%, #b8941f 100%);">
            <svg class="w-8 h-8 text-black" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold mb-4" style="color: #D3AF37;">Track Your Order</h2>
          <p class="text-gray-300 font-medium">Enter your Order ID or Discord username to check status</p>
        </div>

        <div class="max-w-2xl mx-auto">
          <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1 relative">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <input type="text" id="order-id-input" placeholder="Order ID (SA-1234567890) or Discord Username"
                     class="w-full pl-12 pr-4 py-4 rounded-xl text-white border border-opacity-30 focus:border-opacity-100 focus:ring-2 focus:ring-yellow-500/20 transition-all duration-300 font-medium focus:outline-none shadow-lg"
                     style="background-color: #1a1a1a; border-color: #D3AF37;">
            </div>
            <button onclick="trackOrder()" id="track-order-btn"
                    class="professional-button px-8 py-4 font-bold rounded-xl flex items-center justify-center space-x-2 shadow-xl">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
              </svg>
              <span>Track Order</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Order Status Display -->
      <div id="order-status-display" class="hidden">
        <div class="bg-gray-800 p-8 rounded-lg border border-opacity-20" style="border-color: #D3AF37;">
          <div class="text-center mb-6">
            <h3 class="text-2xl font-light mb-2" style="color: #D3AF37;">Order Details</h3>
            <p class="text-gray-300" id="order-id-display">Order ID: SA-1234567890</p>
          </div>

          <!-- Status Progress Bar -->
          <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
              <div class="flex flex-col items-center">
                <div id="status-pending" class="w-8 h-8 rounded-full border-2 flex items-center justify-center mb-2" style="border-color: #D3AF37;">
                  <span class="text-xs">üìã</span>
                </div>
                <span class="text-xs text-gray-400">Received</span>
              </div>
              <div class="flex-1 h-1 mx-2 bg-gray-600 rounded">
                <div id="progress-bar-1" class="h-full bg-gray-600 rounded transition-all duration-500" style="width: 0%;"></div>
              </div>
              <div class="flex flex-col items-center">
                <div id="status-processing" class="w-8 h-8 rounded-full border-2 border-gray-600 flex items-center justify-center mb-2">
                  <span class="text-xs">‚öôÔ∏è</span>
                </div>
                <span class="text-xs text-gray-400">Processing</span>
              </div>
              <div class="flex-1 h-1 mx-2 bg-gray-600 rounded">
                <div id="progress-bar-2" class="h-full bg-gray-600 rounded transition-all duration-500" style="width: 0%;"></div>
              </div>
              <div class="flex flex-col items-center">
                <div id="status-ready" class="w-8 h-8 rounded-full border-2 border-gray-600 flex items-center justify-center mb-2">
                  <span class="text-xs">üöö</span>
                </div>
                <span class="text-xs text-gray-400">Shipping</span>
              </div>
              <div class="flex-1 h-1 mx-2 bg-gray-600 rounded">
                <div id="progress-bar-3" class="h-full bg-gray-600 rounded transition-all duration-500" style="width: 0%;"></div>
              </div>
              <div class="flex flex-col items-center">
                <div id="status-completed" class="w-8 h-8 rounded-full border-2 border-gray-600 flex items-center justify-center mb-2">
                  <span class="text-xs">‚úîÔ∏è</span>
                </div>
                <span class="text-xs text-gray-400">Completed</span>
              </div>
            </div>
          </div>

          <!-- Current Status -->
          <div class="text-center mb-6">
            <div class="inline-block px-6 py-3 rounded-full text-lg font-medium mb-4" id="current-status-badge" style="background-color: #D3AF37; color: #141414;">
              üìã Received
            </div>
            <p class="text-gray-300" id="status-description">Your order has been received and is waiting to be processed.</p>
          </div>

          <!-- Order Items -->
          <div class="border-t border-gray-600 pt-6">
            <h4 class="text-lg font-light mb-4" style="color: #D3AF37;">Order Items</h4>
            <div id="order-items-list" class="space-y-2">
              <!-- Items will be populated here -->
            </div>
          </div>

          <!-- Order Info -->
          <div class="border-t border-gray-600 pt-6 mt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-400">Order Date:</p>
                <p class="text-white" id="order-date">January 15, 2025</p>
              </div>
              <div>
                <p class="text-gray-400">Fulfillment Method:</p>
                <p class="text-white" id="fulfillment-method">Collection at Seraphim Station</p>
              </div>
              <div>
                <p class="text-gray-400">Total Amount:</p>
                <p class="text-white" id="order-total">15,000 aUEC</p>
              </div>
              <div>
                <p class="text-gray-400">Contact:</p>
                <p class="text-white" id="customer-discord">@username</p>
              </div>
              <div>
                <p class="text-gray-400">Payment Received:</p>
                <p class="text-white" id="payment-status">‚ùå</p>
              </div>
            </div>
          </div>

          <!-- Contact Support -->
          <div class="border-t border-gray-600 pt-6 mt-6 text-center">
            <p class="text-gray-400 text-sm mb-2">Need help with your order?</p>
            <p class="text-white text-sm">Contact us on Discord or at Seraphim Station</p>
          </div>
        </div>
      </div>

      <!-- Order Not Found -->
      <div id="order-not-found" class="hidden">
        <div class="bg-red-900 bg-opacity-20 border border-red-500 border-opacity-30 p-8 rounded-lg text-center">
          <h3 class="text-xl font-light mb-4 text-red-400">Order Not Found</h3>
          <p class="text-gray-300 mb-4">We couldn't find an order with that Order ID or Discord username. Please check your information and try again.</p>
          <p class="text-sm text-gray-400">You can search using either your Order ID (starts with "SA-") or your Discord username.</p>
        </div>
      </div>

      <!-- Loading State -->
      <div id="order-loading" class="hidden">
        <div class="bg-gray-800 p-8 rounded-lg border border-opacity-20 text-center" style="border-color: #D3AF37;">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto mb-4" style="border-color: #D3AF37;"></div>
          <p class="text-gray-300">Looking up your order...</p>
        </div>
      </div>

      <!-- Back to Store -->
      <div class="text-center mt-8">
        <a href="index.html" class="inline-block px-6 py-3 font-medium rounded transition-all duration-300 border border-opacity-30"
           style="border-color: #D3AF37; color: white;"
           onmouseover="this.style.backgroundColor='#D3AF37'; this.style.color='#141414'"
           onmouseout="this.style.backgroundColor='transparent'; this.style.color='white'">
          ‚Üê Back to Store
        </a>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-8 px-4 border-t border-opacity-20 text-center" style="background-color: #141414; border-color: #D3AF37;">
    <p class="text-gray-400 text-sm">¬© 2025 The Seraph Armory - Operating from Seraphim Station</p>
  </footer>

  <script>
    // Utility function to format prices
    function formatPrice(price) {
      if (typeof price === 'string') {
        if (price.toLowerCase() === 'free') return 'Free';
        return price;
      }
      return price.toLocaleString() + ' aUEC';
    }

    // Order Status Tracking Functions
    async function trackOrder() {
      const orderIdInput = document.getElementById('order-id-input');
      const searchInput = orderIdInput.value.trim();

      if (!searchInput) {
        alert('Please enter an Order ID or Discord username');
        return;
      }

      // Show loading state
      showOrderLoading();

      try {
        // Detect if input is Order ID or Discord username
        const searchType = detectInputType(searchInput);

        // Look up order in Google Sheets
        const orderData = await lookupOrderInSheets(searchInput, searchType);

        if (orderData) {
          displayOrderStatus(orderData);
        } else {
          showOrderNotFound();
        }
      } catch (error) {
        console.error('Error tracking order:', error);
        alert('Error looking up order. Please try again.');
        hideOrderDisplays();
      }
    }

    function detectInputType(input) {
      // Remove @ symbol if present and trim
      const cleanInput = input.replace('@', '').trim();

      // If starts with "SA-" and has numbers, it's an Order ID
      if (cleanInput.startsWith('SA-') && /^SA-\d+$/.test(cleanInput)) {
        return 'orderId';
      }

      // Otherwise treat as Discord username
      return 'username';
    }

    async function lookupOrderInSheets(searchValue, searchType) {
      try {
        const { APPS_SCRIPT_URL } = window.GOOGLE_SHEETS_CONFIG;

        // Prepare data for lookup request
        const formData = new FormData();
        formData.append('action', 'lookupOrder');

        if (searchType === 'orderId') {
          formData.append('orderId', searchValue);
        } else {
          // For username search, remove @ symbol and make case-insensitive
          const cleanUsername = searchValue.replace('@', '').trim();
          formData.append('discordUsername', cleanUsername);
        }

        // Call Google Apps Script to lookup order using POST
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Lookup response:', result);

        if (result.success) {
          return result.orderData;
        } else {
          console.log('Order not found:', result.error);
          return null; // Order not found
        }

      } catch (error) {
        console.error('Error looking up order:', error);
        throw error;
      }
    }

    function displayOrderStatus(orderData) {
      hideOrderDisplays();

      const statusDisplay = document.getElementById('order-status-display');
      statusDisplay.classList.remove('hidden');

      // Update order details
      document.getElementById('order-id-display').textContent = `Order ID: ${orderData.orderId}`;
      document.getElementById('order-date').textContent = orderData.date;
      document.getElementById('fulfillment-method').textContent = orderData.fulfillmentMethod === 'Collection' ? `Collection at ${orderData.deliveryLocation}` : `Delivery to ${orderData.deliveryLocation}`;
      document.getElementById('order-total').textContent = `${formatPrice(orderData.total)}`;
      document.getElementById('customer-discord').textContent = `@${orderData.discordUsername}`;

      // Update payment status
      document.getElementById('payment-status').textContent = orderData.paymentReceived ? '‚úîÔ∏è' : '‚ùå';

      // Update status progress
      updateStatusProgress(orderData.status);

      // Update order items
      const itemsList = document.getElementById('order-items-list');
      itemsList.innerHTML = '';
      orderData.items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'flex justify-between text-sm';
        itemDiv.innerHTML = `
          <span class="text-gray-300">${item.quantity}x ${item.name} (${item.variant})</span>
          <span class="text-white">${formatPrice(item.itemTotal)}</span>
        `;
        itemsList.appendChild(itemDiv);
      });
    }

    function updateStatusProgress(status) {
      // Reset all status indicators
      const statusElements = ['pending', 'processing', 'ready', 'completed'];
      const progressBars = ['progress-bar-1', 'progress-bar-2', 'progress-bar-3'];

      statusElements.forEach(s => {
        const element = document.getElementById(`status-${s}`);
        element.style.borderColor = '#6b7280';
        element.style.backgroundColor = 'transparent';
      });

      progressBars.forEach(p => {
        const element = document.getElementById(p);
        element.style.backgroundColor = '#6b7280';
        element.style.width = '0%';
      });

      // Update based on current status
      const statusConfig = {
        'Received': {
          activeSteps: ['pending'],
          progressBars: [],
          badge: 'üìã Received',
          description: 'Your order has been received and is waiting to be processed.',
          badgeColor: '#6b7280'  // Gray
        },
        'Processing': {
          activeSteps: ['pending', 'processing'],
          progressBars: ['progress-bar-1'],
          badge: '‚öôÔ∏è Processing',
          description: 'We are currently gathering your items and preparing your order.',
          badgeColor: '#3b82f6'  // Blue
        },
        'Shipping': {
          activeSteps: ['pending', 'processing', 'ready'],
          progressBars: ['progress-bar-1', 'progress-bar-2'],
          badge: 'üöö Shipping',
          description: 'Your order is being delivered to the specified location.',
          badgeColor: '#06b6d4'  // Turquoise
        },
        'Ready for Collection': {
          activeSteps: ['pending', 'processing', 'ready'],
          progressBars: ['progress-bar-1', 'progress-bar-2'],
          badge: 'üì¶ Ready for Collection',
          description: 'Your order is ready! Please collect it at Seraphim Station.',
          badgeColor: '#10b981'  // Green
        },
        'Completed': {
          activeSteps: ['pending', 'processing', 'ready', 'completed'],
          progressBars: ['progress-bar-1', 'progress-bar-2', 'progress-bar-3'],
          badge: '‚úîÔ∏è Completed',
          description: 'Your order has been completed successfully. Thank you!',
          badgeColor: '#10b981'  // Green
        },
        'Cancelled': {
          activeSteps: [],
          progressBars: [],
          badge: '‚ùå Cancelled',
          description: 'Your order has been cancelled. If you have any questions, please contact us.',
          badgeColor: '#ef4444'  // Red
        }
      };

      const config = statusConfig[status] || statusConfig['Received'];

      // Activate status steps
      config.activeSteps.forEach(step => {
        const element = document.getElementById(`status-${step}`);
        element.style.borderColor = '#D3AF37';
        element.style.backgroundColor = '#D3AF37';
      });

      // Activate progress bars
      config.progressBars.forEach(bar => {
        const element = document.getElementById(bar);
        element.style.backgroundColor = '#D3AF37';
        element.style.width = '100%';
      });

      // Update status badge and description
      const statusBadge = document.getElementById('current-status-badge');
      const statusDescription = document.getElementById('status-description');

      statusBadge.textContent = config.badge;
      statusBadge.style.backgroundColor = config.badgeColor;
      statusDescription.textContent = config.description;
    }

    function showOrderLoading() {
      hideOrderDisplays();
      document.getElementById('order-loading').classList.remove('hidden');
    }

    function showOrderNotFound() {
      hideOrderDisplays();
      document.getElementById('order-not-found').classList.remove('hidden');
    }

    function hideOrderDisplays() {
      document.getElementById('order-status-display').classList.add('hidden');
      document.getElementById('order-not-found').classList.add('hidden');
      document.getElementById('order-loading').classList.add('hidden');
    }

    // Allow Enter key to trigger order tracking
    document.addEventListener('DOMContentLoaded', function() {
      const orderIdInput = document.getElementById('order-id-input');
      if (orderIdInput) {
        orderIdInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            trackOrder();
          }
        });
      }
    });
  </script>
</body>
</html>
