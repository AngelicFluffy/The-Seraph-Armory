<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Seraph Armory</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/HLRNP3m4/1719-lpinkwing.gif">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="google-sheets-config.js?v=2"></script>
  <style>
    html {
      scroll-behavior: smooth;
    }

    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .rainbow-hover {
      position: relative;
      z-index: 0;
      overflow: hidden;
      border: 1px solid #D3AF37;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: #1a1a1a;
      backdrop-filter: blur(10px);
    }
    .rainbow-hover:hover {
      background: #D3AF37;
      color: #141414;
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(211, 175, 55, 0.4);
    }
    @keyframes wave {
      0% {
        background-position: 0% 50%;
      }
      100% {
        background-position: 100% 50%;
      }
    }
    
    .welcome-text {
      opacity: 0;
      transform: translateY(-50px);
      animation: slideDownFadeIn 1s ease-out forwards;
    }
    
    .armory-text {
      opacity: 0;
      transform: translateY(50px);
      animation: slideUpFadeIn 1s ease-out 1s forwards;
    }
    
    @keyframes slideDownFadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideUpFadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .weapon-image {
      aspect-ratio: 16/7;
      object-fit: cover;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .weapon-image:hover {
      transform: scale(1.02);
    }

    .p-card {
      background: linear-gradient(145deg, #1a1a1a 0%, #1f1f1f 100%);
      border: 1px solid rgba(211, 175, 55, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .p-card:hover {
      border-color: rgba(211, 175, 55, 0.5);
      box-shadow: 0 8px 32px rgba(211, 175, 55, 0.1);
      transform: translateY(-2px);
    }

    .p-button {
      background: linear-gradient(135deg, #D3AF37 0%, #b8941f 100%);
      border: none;
      color: #141414;
      font-weight: 500;
      letter-spacing: 0.025em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(211, 175, 55, 0.3);
    }

    .p-button:hover {
      background: linear-gradient(135deg, #b8941f 0%, #a0821b 100%);
      box-shadow: 0 6px 20px rgba(211, 175, 55, 0.4);
      transform: translateY(-1px);
    }

    .p-button-secondary {
      background: transparent;
      border: 1px solid rgba(211, 175, 55, 0.5);
      color: #D3AF37;
      font-weight: 500;
      letter-spacing: 0.025em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .p-button-secondary:hover {
      background: rgba(211, 175, 55, 0.1);
      border-color: #D3AF37;
      color: #D3AF37;
    }

    .section-header {
      background: linear-gradient(90deg, transparent 0%, rgba(211, 175, 55, 0.1) 50%, transparent 100%);
      border-bottom: 1px solid rgba(211, 175, 55, 0.3);
      padding: 1rem 0;
      margin-bottom: 2rem;
    }

    .nav-link:hover {
      background-color: rgba(211, 175, 55, 0.1);
      color: #D3AF37 !important;
      transform: translateY(-1px);
    }

    .dropdown-link:hover {
      background-color: rgba(211, 175, 55, 0.15);
      color: #D3AF37 !important;
      padding-left: 2rem;
    }

    /* Dropdown Menu Styles */
    .weapons-dropdown {
      position: absolute;
      left: 0;
      top: 100%;
      width: 200px;
      background-color: #1a1a1a;
      border: 1px solid rgba(211, 175, 55, 0.3);
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 1000;
      margin-top: 0.5rem;
    }

    .weapons-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .weapons-dropdown a {
      display: block;
      padding: 0.75rem 1rem;
      color: white;
      text-decoration: none;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(211, 175, 55, 0.1);
    }

    .weapons-dropdown a:last-child {
      border-bottom: none;
    }

    .weapons-dropdown a:hover {
      background-color: rgba(211, 175, 55, 0.15);
      color: #D3AF37;
      padding-left: 1.5rem;
    }

    /* Loading Screen */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
      overflow: hidden;
    }

    #loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-content {
      text-align: center;
      position: relative;
      z-index: 10;
    }

    /* Orbital System */
    .orbital-system {
      width: 200px;
      height: 200px;
      position: relative;
      margin: 0 auto 40px;
    }

    .planet {
      width: 60px;
      height: 60px;
      background: radial-gradient(circle at 30% 30%, #4a90e2, #2c5aa0);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 40px rgba(74, 144, 226, 0.6), inset -2px -2px 10px rgba(0, 0, 0, 0.5);
    }

    .planet::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
    }

    .orbit {
      position: absolute;
      border: 1px solid rgba(211, 175, 55, 0.3);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .orbit-1 {
      width: 140px;
      height: 140px;
      animation: rotate 8s linear infinite;
    }

    .orbit-2 {
      width: 180px;
      height: 180px;
      animation: rotate 12s linear infinite reverse;
    }

    .moon {
      position: absolute;
      border-radius: 50%;
      top: 50%;
      left: 50%;
    }

    .moon-1 {
      width: 20px;
      height: 20px;
      background: radial-gradient(circle at 35% 35%, #e8d4a0, #c9a961);
      box-shadow: 0 0 15px rgba(232, 212, 160, 0.8), inset -1px -1px 3px rgba(0, 0, 0, 0.4);
      transform: translate(-50%, -50%);
      margin-top: -70px;
    }

    .moon-2 {
      width: 15px;
      height: 15px;
      background: radial-gradient(circle at 40% 40%, #d4af37, #a0860f);
      box-shadow: 0 0 12px rgba(212, 175, 55, 0.7), inset -1px -1px 2px rgba(0, 0, 0, 0.5);
      transform: translate(-50%, -50%);
      margin-top: -90px;
    }

    @keyframes rotate {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .loading-text {
      color: #D3AF37;
      font-size: 1.25rem;
      font-weight: 500;
      letter-spacing: 0.05em;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Starfield background */
    .starfield {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: twinkle 3s infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* Toast notification fix */
    #toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9998;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .p-card {
        margin: 0.5rem;
      }

      .grid-cols-3 {
        grid-template-columns: 1fr;
      }

      .nav-link {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
      }

      #cart-sidebar {
        width: 100vw;
      }

      .text-5xl, .text-6xl, .text-7xl, .text-8xl {
        font-size: 2.5rem;
      }

      .md\:text-7xl, .md\:text-8xl {
        font-size: 3rem;
      }
    }
  </style>
</head>
<body class="text-white font-sans" style="background-color: #141414;">

  <!-- Loading Screen -->
  <div id="loading-screen">
    <div class="starfield" id="starfield"></div>
    <div class="loading-content">
      <div class="orbital-system">
        <div class="planet"></div>
        <div class="orbit orbit-1">
          <div class="moon moon-1"></div>
        </div>
        <div class="orbit orbit-2">
          <div class="moon moon-2"></div>
        </div>
      </div>
      <div class="loading-text">Loading Armory...</div>
    </div>
  </div>

  <!-- Hero Section -->
  <section class="min-h-screen flex items-center justify-center bg-cover bg-center bg-no-repeat relative" id="hero-section" style="background-color: #202020cc;">
    <div class="absolute inset-0 bg-gradient-to-b from-transparent via-black/20 to-black/40"></div>
    <div class="relative text-center p-16 rounded-2xl backdrop-blur-md border border-opacity-30 shadow-2xl max-w-4xl mx-4" style="background-color: rgba(0, 0, 0, 0.5); border-color: #D3AF37;">
      <h1 class="text-5xl md:text-7xl font-light mb-8 welcome-text tracking-wide">Welcome to</h1>
      <h2 class="text-6xl md:text-8xl font-bold armory-text tracking-tight" style="color: #D3AF37; text-shadow: 0 4px 20px rgba(211, 175, 55, 0.3);">The Seraph Armory</h2>
      <p id="motd-text" class="text-xl md:text-2xl font-light text-gray-300 mt-8 opacity-90">For everything you would ever need.</p>
    </div>
  </section>

<!-- Store Status Bar -->
<section class="py-12 px-4 border-b border-opacity-20" style="background-color: #141414; border-color: #D3AF37;">
  <div class="max-w-6xl mx-auto">
    <!-- Status Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- Store Status Card -->
      <div class="p-card p-6 text-center">
        <div class="text-3xl mb-3">üü¢</div>
        <h3 class="text-lg font-semibold mb-2" style="color: #D3AF37;">Store Status</h3>
        <span class="inline-block px-4 py-2 rounded-full font-medium text-sm text-black p-button">
          OPEN
        </span>
      </div>

      <!-- Game Info Card -->
      <div class="p-card p-6 text-center">
        <div class="text-3xl mb-3">üéÆ</div>
        <h3 class="text-lg font-semibold mb-2" style="color: #D3AF37;">Game Version</h3>
        <p class="text-white font-medium">4.3.2</p>
        <p class="text-sm text-gray-400 mt-1">Prices Updated: <span id="price-update-date"></span></p>
      </div>

      <!-- Services Card -->
      <div class="p-card p-6 text-center">
        <div class="text-3xl mb-3">‚öñÔ∏è</div>
        <h3 class="text-lg font-semibold mb-2" style="color: #D3AF37;">Services</h3>
        <div class="space-y-2">
          <div class="text-sm"><span class="text-green-400">‚úì</span> Selling</div>
          <div class="text-sm"><span class="text-green-400">‚úì</span> Buying</div>
        </div>
      </div>
    </div>

    <!-- Location & Contact Info -->
    <div class="p-card p-8 text-center">
      <div class="flex items-center justify-center mb-4">
        <div class="text-2xl mr-3">üèõÔ∏è</div>
        <h3 class="text-2xl font-semibold" style="color: #D3AF37;">Seraphim Station</h3>
      </div>
      <p class="text-lg text-gray-300 mb-4">Premium weapons and equipment dealer</p>
      <p class="text-gray-400 max-w-2xl mx-auto leading-relaxed">
        Hello and welcome! Weapon stocks are updated as orders are completed.
        If you have items to sell, please contact me in the thread, or via DM.
      </p>
    </div>
  </div>
</section>

  <!-- Main Navigation -->
  <nav class="sticky top-0 shadow-xl z-50 border-b border-opacity-30 backdrop-blur-md" style="background-color: rgba(20, 20, 20, 0.95); border-color: #D3AF37;">
    <div class="max-w-7xl mx-auto px-4">
      <ul class="flex justify-center items-center space-x-1 py-4" id="main-nav">
        <!-- Navigation will be populated dynamically -->
      </ul>
    </div>
  </nav>

  <!-- Dynamic Sections Container -->
  <div id="dynamic-sections-container"></div>



  <script>
    // Weapons array will be populated dynamically from Google Sheets
    let weapons = [];

    // Map to store weapon data by name for quick lookup
    let weaponDataMap = {};

    // Dynamic category grids - will be populated based on actual data
    let categoryGrids = {};

    // Function to hide/show loading screen
    function showLoadingScreen() {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.classList.remove('hidden');
      }
    }

    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.classList.add('hidden');
      }
    }

      /**
       * Fetch active weapon listings from Google Sheets via Google Apps Script
       */
      async function fetchWeaponListings() {
        try {
          console.log('Fetching weapon listings from Google Sheets...');

          const response = await fetch(GOOGLE_SHEETS_CONFIG.APPS_SCRIPT_URL);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || 'Failed to fetch weapon listings');
          }

          // Group weapons by name and collect all variants
          const weaponsByName = {};

          data.data.weapons.forEach(item => {

            const weaponName = item.name;

            if (!weaponsByName[weaponName]) {
              weaponsByName[weaponName] = {
                name: item.name,
                category: item.category || 'Equipment',
                manufacturer: item.manufacturer || '',
                fullName: item.fullName || `${item.manufacturer || ''} ${item.name}`.trim(),
                listingImage: item.listingImage || '',
                damageType: item.damageType || '',
                magazine: item.magazine || '',
                fireRate: item.fireRate || '',
                range: item.range || '',
                variants: {}
              };
            }

            // Store variant data
            weaponsByName[weaponName].variants[item.variant] = {
              variant: item.variant,
              stock: item.stock,
              isUniversal: item.isUniversal,
              buyPrice: item.buyPrice || 0
            };
          });

          // Filter and prepare weapons for display
          weapons = [];

          // Process all weapons (including kits)
          Object.values(weaponsByName).forEach(weapon => {
            // Find the best variant to display (Stock first, then first available with stock or universal)
            let displayVariant = null;
            let hasAnyAvailable = false;

            // Check if "Stock" variant exists and has availability
            if (weapon.variants['Stock']) {
              const stockVariant = weapon.variants['Stock'];
              if (stockVariant.isUniversal || (typeof stockVariant.stock === 'number' && stockVariant.stock > 0)) {
                displayVariant = 'Stock';
                hasAnyAvailable = true;
              }
            }

            // If Stock variant not available, find first available variant
            if (!displayVariant) {
              for (const [variantName, variantData] of Object.entries(weapon.variants)) {
                if (variantData.isUniversal || (typeof variantData.stock === 'number' && variantData.stock > 0)) {
                  displayVariant = variantName;
                  hasAnyAvailable = true;
                  break;
                }
              }
            }

            // If still no available variant, use Stock variant anyway (for display purposes)
            if (!displayVariant) {
              displayVariant = weapon.variants['Stock'] ? 'Stock' : Object.keys(weapon.variants)[0];
            }

            // Add weapon regardless of availability (to show all items)
            const displayVariantData = weapon.variants[displayVariant];

            // Check if this is a kit
            weapons.push({
              name: weapon.name,
              listingImage: weapon.listingImage,
              buyPrice: displayVariantData.buyPrice,
              stock: displayVariantData.stock,
              isUniversal: displayVariantData.isUniversal,
              damageType: weapon.damageType,
              magazine: weapon.magazine,
              fireRate: weapon.fireRate,
              range: weapon.range,
              manufacturer: weapon.manufacturer,
              fullName: weapon.fullName,
              category: weapon.category,
              variant: displayVariant,
              allVariants: weapon.variants, // Store all variants for selection
              hasAvailableVariants: hasAnyAvailable // Track if any variants are available
            });
          });

          // Build a map for quick lookup
          weaponDataMap = {};
          weapons.forEach(weapon => {
            const key = weapon.name.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (!weaponDataMap[key]) {
              weaponDataMap[key] = [];
            }
            weaponDataMap[key].push(weapon);
          });

          // Process kits if available
          if (data.data.kits && Array.isArray(data.data.kits)) {
            data.data.kits.forEach(kit => {
              weapons.push({
                name: kit.name,
                listingImage: kit.listingImage,
                buyPrice: 0, // Kits don't have a direct price
                stock: 'In stock',
                isUniversal: true,
                category: 'Kit',
                variant: 'Default',
                allVariants: { 'Default': { buyPrice: 0, stock: 'In stock', isUniversal: true } },
                hasAvailableVariants: true,
                isKit: true,
                kitComponents: {
                  armor: kit.armor || [],
                  weapons: kit.weapons || [],
                  equipment: kit.equipment || []
                }
              });
            });
          }

          // Build dynamic category grids based on actual data
          buildDynamicCategoryGrids();

          console.log(`Loaded ${weapons.length} active weapon listings from Google Sheets`);
          return weapons;

        } catch (error) {
          console.error('Error fetching weapon listings:', error);
          showToast('Failed to load weapon listings from Google Sheets', 'error');
          return [];
        }
      }

      /**
       * Build category grids dynamically based on available categories
       */
      function buildDynamicCategoryGrids() {
        // Get unique categories from weapons
        let categories = [...new Set(weapons.map(w => w.category))];

        // Custom category names and descriptions
        const categoryInfo = {
          'Heavy': { name: 'Heavy Weapons', desc: 'When you need a really big fucking hole' },
          'LMG': { name: 'LMG', desc: 'Sustained firepower for extended engagements' },
          'Shotgun': { name: 'Shotguns', desc: 'Close quarters devastation' },
          'Sniper Rifle': { name: 'Sniper Rifles', desc: 'Precision from a distance' },
          'Rifle': { name: 'Rifles', desc: 'Reliable and versatile' },
          'SMG': { name: 'SMG', desc: 'Fast and deadly' },
          'Pistol': { name: 'Pistols', desc: 'Compact and efficient' },
          'Equipment': { name: 'Equipment', desc: 'Tools and accessories' },
          'Armor': { name: 'Armor', desc: 'Protection for the discerning pilot' },
          'Kit': { name: 'Bundles', desc: 'Complete loadout packages' }
        };

        // Sort categories in specified order
        const categoryOrder = ['Kit', 'Heavy', 'LMG', 'Shotgun', 'Sniper Rifle', 'Rifle', 'SMG', 'Pistol', 'Equipment', 'Armor'];
        categories = categories.sort((a, b) => {
          const indexA = categoryOrder.indexOf(a);
          const indexB = categoryOrder.indexOf(b);
          return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
        });

        console.log('Available categories:', categories);

        // Clear existing grids
        categoryGrids = {};

        // Get the container where we'll add all sections
        const container = document.getElementById('dynamic-sections-container');
        if (!container) {
          console.error('dynamic-sections-container not found');
          return;
        }

        // Clear the container
        container.innerHTML = '';

        // Create a section for each category
        categories.forEach(category => {
          const sectionId = category.toLowerCase().replace(/\s+/g, '-');
          const gridId = sectionId + '-grid';
          const info = categoryInfo[category] || { name: category, desc: `Premium ${category.toLowerCase()} from across the galaxy` };

          // Create the section element
          const section = document.createElement('section');
          section.className = 'py-20 px-4';
          section.style.backgroundColor = '#141414';
          section.id = sectionId;
          section.setAttribute('data-category', category);

          // Create the section content
          section.innerHTML = `
            <div class="mx-auto" style="max-width: 1600px;">
              <div class="section-header text-center mb-16">
                <h2 class="text-4xl font-bold mb-4" style="color: #D3AF37;">${info.name}</h2>
                <p class="text-xl text-gray-300 font-light">${info.desc}</p>
              </div>
              <div id="${gridId}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
          `;

          // Add the section to the container
          container.appendChild(section);

          // Store the grid element reference
          const gridElement = document.getElementById(gridId);
          categoryGrids[category] = gridElement;

          console.log(`Created section for category: ${category}`);
        });

        // Update navigation with dynamic categories
        buildDynamicNavigation(categories);
      }

      /**
       * Build navigation with: Bundles | Weapons (dropdown) | Armor | Hangar || Order Status | Cart
       */
      function buildDynamicNavigation(categories) {
        const navContainer = document.getElementById('main-nav');
        if (!navContainer) return;

        navContainer.innerHTML = '';

        // Helper function to create divider
        function createDivider(isHard = false) {
          const li = document.createElement('li');
          li.className = 'flex items-center mx-4';
          const divClass = isHard ? 'w-px h-8 bg-yellow-600 opacity-100' : 'w-px h-8 bg-gradient-to-b from-transparent via-yellow-600 to-transparent opacity-50';
          li.innerHTML = `<div class="${divClass}"></div>`;
          return li;
        }

        // 1. Bundles link
        const bundlesLi = document.createElement('li');
        const bundlesA = document.createElement('a');
        bundlesA.href = 'index.html?category=Kit';
        bundlesA.className = 'nav-link px-4 py-3 rounded-lg font-medium text-base transition-all duration-300';
        bundlesA.style.color = 'white';
        bundlesA.textContent = 'Bundles';
        bundlesLi.appendChild(bundlesA);
        navContainer.appendChild(bundlesLi);

        // Divider
        navContainer.appendChild(createDivider());

        // 2. Weapons dropdown with categories
        const weaponsLi = document.createElement('li');
        weaponsLi.className = 'relative';
        const weaponsButton = document.createElement('button');
        weaponsButton.className = 'nav-link px-4 py-3 rounded-lg font-medium text-base transition-all duration-300 flex items-center space-x-2';
        weaponsButton.style.color = 'white';
        weaponsButton.style.border = 'none';
        weaponsButton.style.background = 'transparent';
        weaponsButton.style.cursor = 'pointer';
        weaponsButton.innerHTML = `
          Weapons
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        `;
        weaponsLi.appendChild(weaponsButton);

        // Dropdown menu
        const dropdownDiv = document.createElement('div');
        dropdownDiv.className = 'weapons-dropdown';
        dropdownDiv.id = 'weapons-dropdown-menu';

        // Add weapon categories to dropdown (excluding Kit)
        const weaponCategories = categories.filter(c => c !== 'Kit').sort();
        weaponCategories.forEach(category => {
          const dropdownLink = document.createElement('a');
          dropdownLink.href = `index.html?category=${category}`;
          dropdownLink.className = 'dropdown-link';
          dropdownLink.textContent = category;
          dropdownDiv.appendChild(dropdownLink);
        });

        weaponsLi.appendChild(dropdownDiv);

        // Add click handler for dropdown
        weaponsButton.addEventListener('click', function(e) {
          e.preventDefault();
          dropdownDiv.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!weaponsLi.contains(e.target)) {
            dropdownDiv.classList.remove('show');
          }
        });

        navContainer.appendChild(weaponsLi);

        // 3. Armor link
        const armorLi = document.createElement('li');
        const armorA = document.createElement('a');
        armorA.href = 'index.html?category=Armor';
        armorA.className = 'nav-link px-4 py-3 rounded-lg font-medium text-base transition-all duration-300';
        armorA.style.color = 'white';
        armorA.textContent = 'Armor';
        armorLi.appendChild(armorA);
        navContainer.appendChild(armorLi);

        // Divider
        navContainer.appendChild(createDivider());

        // 4. Hangar link
        const hangarLi = document.createElement('li');
        const hangarA = document.createElement('a');
        hangarA.href = 'hangar.html';
        hangarA.className = 'nav-link px-4 py-3 rounded-lg font-medium text-base transition-all duration-300';
        hangarA.style.color = 'white';
        hangarA.textContent = 'Hangar';
        hangarLi.appendChild(hangarA);
        navContainer.appendChild(hangarLi);

        // Hard divider
        navContainer.appendChild(createDivider(true));

        // 5. Order Status link
        const orderLi = document.createElement('li');
        const orderA = document.createElement('a');
        orderA.href = 'order-status.html';
        orderA.className = 'nav-link px-4 py-3 rounded-lg font-medium text-base transition-all duration-300';
        orderA.style.color = 'white';
        orderA.textContent = 'Order Status';
        orderLi.appendChild(orderA);
        navContainer.appendChild(orderLi);

        // 6. Cart Button
        const cartLi = document.createElement('li');
        cartLi.innerHTML = `
          <button onclick="toggleCart()" class="p-button px-6 py-3 rounded-lg font-medium text-base flex items-center space-x-2 ml-4">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
            </svg>
            <span>Cart (<span id="cart-count">0</span>)</span>
          </button>
        `;
        navContainer.appendChild(cartLi);
      }

      // Function to render weapons with Google Sheets data
      function renderWeapons() {
        weapons.forEach((weapon) => {
          // Handle kits separately
          if (weapon.isKit) {
            renderKitCard(weapon);
            return;
          }

          const name = weapon.name;
          const image = weapon.listingImage || 'https://via.placeholder.com/400x300?text=No+Image';
          const price = weapon.buyPrice || 0;
          const stock = weapon.stock; // Can be number or "In stock"
          const isUniversal = weapon.isUniversal;
          const damage = weapon.damageType || 'N/A';
          const mag = weapon.magazine || 'N/A';
          const fireRate = weapon.fireRate || 'N/A';
          const range = weapon.range || 'N/A';
          const fullName = weapon.fullName || name;
          const category = weapon.category || 'Equipment';

          let actualPrice = formatPrice(price);

          // Get only available variants (those with stock or universal)
          let actualVariants = [];
          if (weapon.allVariants) {
            Object.entries(weapon.allVariants).forEach(([variantName, variantData]) => {
              if (variantData.isUniversal || (typeof variantData.stock === 'number' && variantData.stock > 0)) {
                actualVariants.push(variantName);
              }
            });
          }

          // If no available variants, show all variants but they'll be disabled
          if (actualVariants.length === 0) {
            actualVariants = Object.keys(weapon.allVariants || {});
            if (actualVariants.length === 0) {
              actualVariants = [weapon.variant || 'Default'];
            }
          }

          // Calculate actual stock for UI purposes
          let actualStock = isUniversal ? 999999 : (typeof stock === 'number' ? stock : 0);

          const card = document.createElement('div');
          card.className = "p-card rounded-2xl overflow-hidden shadow-2xl";
          card.style.backgroundColor = "#1a1a1a";
          card.style.borderColor = "#D3AF37";

          // Determine stock display based on Universal field
          let stockLabel = '';
          let stockColor = '';
          let stockTextColor = 'white';
          let showStockAmount = false;
          let stockEmoji = '‚úîÔ∏è';

          // If Universal (E) = TRUE, display "In stock" without quantity
          // If Universal (E) = FALSE, display stock quantity from D
          if (weapon.isUniversal) {
            stockLabel = 'In Stock';
            stockColor = '#00aa00';
            stockEmoji = '‚úîÔ∏è';
            showStockAmount = false;
          } else if (actualStock === 0) {
            stockLabel = 'No Stock';
            stockColor = '#aa0000';
            stockEmoji = '‚ùå';
            showStockAmount = false;
          } else if (actualStock >= 1 && actualStock <= 4) {
            stockLabel = 'Low Stock';
            stockColor = '#dfde01';
            stockTextColor = 'black';
            stockEmoji = '‚ö†Ô∏è';
            showStockAmount = true;
          } else {
            stockLabel = 'In Stock';
            stockColor = '#00aa00';
            stockEmoji = '‚úîÔ∏è';
            showStockAmount = true;
          }

          card.innerHTML = `
            <div class="relative">
              <img src="${image}" alt="${name}" class="w-full h-64 object-cover cursor-pointer weapon-image" loading="lazy" onclick="openImage(this.src)" />
              <div class="absolute top-4 right-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold" style="background-color: ${stockColor}; color: ${stockTextColor};">
                  ${stockEmoji} ${stockLabel}
                </span>
              </div>
              ${showStockAmount && actualStock > 0 ? `<div class="absolute bottom-4 left-4 bg-black/70 backdrop-blur-sm rounded-lg px-3 py-1">
                <span class="text-sm font-medium text-white">${actualStock} in stock</span>
              </div>` : ''}
            </div>
            <div class="p-8">
              <div class="mb-6">
                <h3 class="text-2xl font-bold mb-2" style="color: #D3AF37;">${name}</h3>
                <p class="text-gray-400 font-medium">${fullName}</p>
              </div>

              <div class="bg-gradient-to-r from-yellow-500/10 to-amber-500/10 rounded-xl p-4 mb-6 border border-yellow-500/20">
                <div class="flex items-center justify-between">
                  <div>
                    <span class="text-2xl font-bold text-white">${actualPrice}</span>
                  </div>
                  <div class="text-right">
                    <div class="text-sm text-gray-400">Per Unit</div>
                  </div>
                </div>
              </div>

              <div class="flex space-x-3 mb-6">
                <button class="p-button-secondary px-4 py-3 rounded-lg font-medium flex items-center" onclick="toggleDetails(this)">
                  <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                  </svg>
                  Details
                </button>
              </div>

                ${weapon.hasAvailableVariants ? `
                <div class="grid grid-cols-3 gap-4 mb-6">
                  <div class="col-span-2">
                    <label class="block text-sm font-semibold mb-3" style="color: #D3AF37;">Variant</label>
                    <select class="variant-select w-full p-4 rounded-xl text-white border border-opacity-30 focus:border-opacity-100 focus:ring-2 focus:ring-yellow-500/20 transition-all duration-300 font-medium focus:outline-none shadow-lg" style="background-color: #1a1a1a; border-color: #D3AF37;" onchange="updateQuantityMax('${name}', this, this.parentElement.parentElement.querySelector('.quantity-input'))">
                      ${actualVariants.map(v => {
                        const variantData = weapon.allVariants[v];
                        const isAvailable = variantData.isUniversal || (typeof variantData.stock === 'number' && variantData.stock > 0);
                        return `<option value="${v}" ${!isAvailable ? 'disabled' : ''}>${v}${!isAvailable ? ' (Out of Stock)' : ''}</option>`;
                      }).join('')}
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold mb-3" style="color: #D3AF37;">Quantity</label>
                    <input type="number" class="quantity-input w-full p-4 rounded-xl text-white border border-opacity-30 focus:border-opacity-100 focus:ring-2 focus:ring-yellow-500/20 transition-all duration-300 font-medium focus:outline-none shadow-lg text-center" style="background-color: #1a1a1a; border-color: #D3AF37;" value="1" min="1" max="${actualStock}" data-weapon-name="${name}" onchange="validateQuantity(this)">
                  </div>
                </div>
                <button class="p-button w-full py-4 text-lg font-semibold rounded-xl flex items-center justify-center space-x-2" onclick="addToCart('${name}', '${fullName}', this)">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
                  </svg>
                  <span>Add to Cart</span>
                </button>
                ` : `
                <button class="w-full py-4 text-lg font-semibold rounded-xl bg-gray-600 text-gray-400 cursor-not-allowed flex items-center justify-center space-x-2" disabled>
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"></path>
                  </svg>
                  <span>Out of Stock</span>
                </button>
                `}

              <div class="details hidden mt-8 pt-6 border-t border-opacity-20" style="border-color: #D3AF37;">
                <h4 class="text-lg font-bold mb-6 flex items-center" style="color: #D3AF37;">
                  <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                  </svg>
                  Weapon Specifications
                </h4>
                <div class="bg-gray-800/50 rounded-xl p-6">
                  <div class="grid grid-cols-2 md:grid-cols-3 gap-6 text-sm">
                    <div class="text-center">
                      <div class="text-2xl mb-2">‚ö°</div>
                      <p class="font-semibold text-white">Damage Type</p>
                      <p class="text-gray-300">${damage}</p>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl mb-2">üì¶</div>
                      <p class="font-semibold text-white">Magazine</p>
                      <p class="text-gray-300">${mag}</p>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl mb-2">üî•</div>
                      <p class="font-semibold text-white">Fire Rate</p>
                      <p class="text-gray-300">${fireRate}</p>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl mb-2">üìè</div>
                      <p class="font-semibold text-white">Range</p>
                      <p class="text-gray-300">${range}</p>
                    </div>
                  </div>
                </div>
              </div>


            </div>
          `;

          const targetGrid = categoryGrids[category];
          if (targetGrid) {
            targetGrid.appendChild(card);
          }
        });
      }

      /**
       * Render a kit card with components displayed in tabs
       */
      function renderKitCard(kit) {
        const name = kit.name;
        const image = kit.listingImage || 'https://via.placeholder.com/400x300?text=No+Image';
        const category = kit.category || 'Kit';

        const card = document.createElement('div');
        card.className = "p-card rounded-2xl overflow-hidden shadow-2xl";
        card.style.backgroundColor = "#1a1a1a";
        card.style.borderColor = "#D3AF37";

        const armor = kit.kitComponents.armor || [];
        const weapons = kit.kitComponents.weapons || [];
        const equipment = kit.kitComponents.equipment || [];

        card.innerHTML = `
          <div class="relative">
            <img src="${image}" alt="${name}" class="w-full h-64 object-cover cursor-pointer weapon-image" loading="lazy" onclick="openImage(this.src)" />
            <div class="absolute top-4 right-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold" style="background-color: #00aa00; color: white;">
                ‚úîÔ∏è In Stock
              </span>
            </div>
          </div>
          <div class="p-8">
            <div class="mb-6">
              <h3 class="text-2xl font-bold mb-2" style="color: #D3AF37;">${name}</h3>
              <p class="text-gray-400 font-medium">Complete Kit Package</p>
            </div>

            <div class="mb-6">
              <div class="flex space-x-2 mb-4 border-b border-opacity-20" style="border-color: #D3AF37;">
                <button class="kit-tab-btn px-4 py-2 font-medium transition-all duration-300 active" data-tab="armor" style="color: #D3AF37; border-bottom: 2px solid #D3AF37;">
                  Armor (${armor.length})
                </button>
                <button class="kit-tab-btn px-4 py-2 font-medium transition-all duration-300" data-tab="weapons" style="color: white;">
                  Weapons (${weapons.length})
                </button>
                <button class="kit-tab-btn px-4 py-2 font-medium transition-all duration-300" data-tab="equipment" style="color: white;">
                  Equipment (${equipment.length})
                </button>
              </div>

              <div class="kit-tab-content" data-content="armor" style="display: block;">
                <div class="bg-gray-800/50 rounded-xl p-4 space-y-2">
                  ${armor.length > 0 ? armor.map(item => `<div class="text-gray-300">‚Ä¢ ${item}</div>`).join('') : '<div class="text-gray-400 italic">No armor items</div>'}
                </div>
              </div>

              <div class="kit-tab-content" data-content="weapons" style="display: none;">
                <div class="bg-gray-800/50 rounded-xl p-4 space-y-2">
                  ${weapons.length > 0 ? weapons.map(item => `<div class="text-gray-300">‚Ä¢ ${item}</div>`).join('') : '<div class="text-gray-400 italic">No weapons</div>'}
                </div>
              </div>

              <div class="kit-tab-content" data-content="equipment" style="display: none;">
                <div class="bg-gray-800/50 rounded-xl p-4 space-y-2">
                  ${equipment.length > 0 ? equipment.map(item => `<div class="text-gray-300">‚Ä¢ ${item}</div>`).join('') : '<div class="text-gray-400 italic">No equipment</div>'}
                </div>
              </div>
            </div>

            <div class="flex space-x-3">
              <button class="p-button flex-1 px-4 py-3 rounded-lg font-medium" onclick="addKitToCart('${name}', this)">
                <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
                </svg>
                Add to Cart
              </button>
            </div>
          </div>
        `;

        const targetGrid = categoryGrids[category];
        if (targetGrid) {
          targetGrid.appendChild(card);
        }

        // Add tab switching functionality
        const tabButtons = card.querySelectorAll('.kit-tab-btn');
        const tabContents = card.querySelectorAll('.kit-tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');

            // Remove active state from all buttons
            tabButtons.forEach(btn => {
              btn.style.color = 'white';
              btn.style.borderBottom = 'none';
            });

            // Hide all content
            tabContents.forEach(content => {
              content.style.display = 'none';
            });

            // Set active state on clicked button
            this.style.color = '#D3AF37';
            this.style.borderBottom = '2px solid #D3AF37';

            // Show corresponding content
            const activeContent = card.querySelector(`[data-content="${tabName}"]`);
            if (activeContent) {
              activeContent.style.display = 'block';
            }
          });
        });
      }

      // renderWeapons() will be called after weapon data is loaded in DOMContentLoaded
    </script>

  <!-- Image Modal -->
  <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <img id="modalImage" src="" class="max-h-[90%] max-w-[90%] rounded shadow-lg" />
  </div>

  <!-- Cart Sidebar -->
  <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-96 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto border-l border-opacity-30 backdrop-blur-md" style="background-color: rgba(20, 20, 20, 0.95); border-color: #D3AF37;">
    <div class="p-6">
      <div class="flex justify-between items-center mb-8 pb-4 border-b border-opacity-20" style="border-color: #D3AF37;">
        <div class="flex items-center space-x-3">
          <svg class="w-6 h-6" style="color: #D3AF37;" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
          </svg>
          <h2 class="text-2xl font-bold" style="color: #D3AF37;">Shopping Cart</h2>
        </div>
        <button onclick="toggleCart()" class="text-gray-400 hover:text-white text-3xl transition-colors duration-300 hover:bg-gray-700 rounded-lg p-2">&times;</button>
      </div>
      
      <div id="cart-items-sidebar" class="space-y-4 mb-6">
        <!-- Cart items will be populated here -->
      </div>

      <!-- Contact Details Section -->
      <div class="border-t border-opacity-20 pt-8 mb-8" style="border-color: #D3AF37;">
        <h3 class="text-xl font-bold mb-6 flex items-center" style="color: #D3AF37;">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
          </svg>
          Contact Details
        </h3>

        <div class="space-y-6">
          <div>
            <label class="block text-sm font-semibold mb-3 text-gray-300">Discord Username *</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <input type="text" id="discord-username" placeholder="YourDiscordUsername"
                     class="w-full text-white pl-12 pr-4 py-4 rounded-xl border border-opacity-30 focus:border-opacity-100 focus:ring-2 focus:ring-yellow-500/20 transition-all duration-300 font-medium focus:outline-none shadow-lg" style="background-color: #1a1a1a; border-color: #D3AF37;">
            </div>
          </div>

          <div class="bg-blue-500/10 rounded-xl p-4 border border-blue-500/20">
            <label class="text-sm text-blue-300 font-medium block mb-2">üìç Collect from:</label>
            <select id="pickup-location"
                    class="w-full text-white px-4 py-3 rounded-lg border border-blue-500/30 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all duration-300 font-medium focus:outline-none shadow-lg"
                    style="background-color: #1a1a1a; border-color: #4B5563;">
              <option value="Seraphim Station">Seraphim Station</option>
              <option value="Pyro Gateway">Pyro Gateway</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Order Summary & Checkout -->
      <div class="p-card p-6 mb-6">
        <h3 class="text-xl font-bold mb-6 flex items-center" style="color: #D3AF37;">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Order Summary
        </h3>
        <div class="space-y-4">
          <div class="flex justify-between items-center py-2">
            <span class="text-gray-300 font-medium">Subtotal:</span>
            <span id="cart-subtotal" class="font-bold text-white">0 aUEC</span>
          </div>
          <div class="border-t border-opacity-20 pt-4" style="border-color: #D3AF37;">
            <div class="flex justify-between items-center">
              <span class="text-xl font-bold text-white">Total:</span>
              <span id="cart-total-sidebar" class="text-2xl font-bold" style="color: #D3AF37;">0 aUEC</span>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center mb-6">
        <div class="bg-blue-500/10 rounded-xl p-4 mb-6 border border-blue-500/20">
          <p class="text-sm text-blue-300 font-medium mb-2">üìã Ready to checkout?</p>
          <p class="text-xs text-gray-400">Complete your details above and place your order</p>
        </div>

        <button onclick="checkout()" class="p-button w-full py-4 text-lg font-bold rounded-xl flex items-center justify-center space-x-3 shadow-xl">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
          </svg>
          <span>Complete Order</span>
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>

        <p class="text-xs text-gray-400 mt-4 leading-relaxed">
          üìÑ Receipt can be downloaded<br>
          üìä Order will be sent to us for processing
        </p>

        <!-- Google Sheets Status -->
        <div id="sheets-status" class="mt-4 text-xs text-center hidden">
          <span id="sheets-status-text" class="px-3 py-2 rounded-lg"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Overlay -->
  <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40" onclick="toggleCart()"></div>

  <!-- Toast Notification -->
  <div id="toast-notification" class="fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl transform translate-x-full transition-all duration-300 z-50 backdrop-blur-md border border-opacity-30" style="background-color: #D3AF37; color: #141414; border-color: #b8941f;">
    <div class="flex items-center space-x-3">
      <div class="flex-shrink-0">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
        </svg>
      </div>
      <span id="toast-message" class="font-semibold">Item added to cart!</span>
    </div>
  </div>

  <!-- Order Success Modal -->
  <div id="order-success-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="p-card max-w-lg w-full mx-4 shadow-2xl" style="background-color: #1a1a1a; border: 2px solid #D3AF37;">
      <div class="p-10 text-center">
        <!-- Header -->
        <div class="mb-8">
          <div class="w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #D3AF37 0%, #b8941f 100%);">
            <svg class="w-10 h-10 text-black" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <div class="text-3xl font-bold mb-3" style="color: #D3AF37;">ORDER CONFIRMED</div>
          <div id="modal-order-id" class="text-xl font-semibold text-white mb-2">ORDER ID: SA-123456</div>
          <div class="text-lg text-gray-300 font-medium">Your order has been successfully received</div>
        </div>

        <!-- Message -->
        <div id="modal-message" class="bg-gray-800/50 rounded-xl p-6 text-sm text-gray-300 mb-8 text-left">
          <!-- Order details will be inserted here -->
        </div>

        <!-- Action Buttons -->
        <div class="space-y-4">
          <button onclick="downloadReceipt()" class="p-button w-full py-4 text-lg font-bold rounded-xl flex items-center justify-center space-x-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
            <span>Download Receipt</span>
          </button>

          <button onclick="goToTracking()" class="p-button-secondary w-full py-4 text-lg font-bold rounded-xl flex items-center justify-center space-x-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
            </svg>
            <span>Track Order</span>
          </button>

          <button onclick="closeOrderModal()" class="w-full py-3 text-sm font-medium text-gray-400 hover:text-white transition-colors duration-300 rounded-lg hover:bg-gray-700/50">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Google Sheets Configuration
    window.GOOGLE_SHEETS_CONFIG = {
      SHEET_ID: '1nOJrh5M9wsw4cIz3MRBSfOKrfFIdOGcVwPwMKpo9u-s',
      // Google Apps Script Web App URL (CORRECT DEPLOYMENT)
      APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyRedcsepf_lTjLUAHqyXEvY3Tu2MYVJNcg7gmebl4ou6qckn8zNCCUcC7Ps_uEE4SIwQ/exec',
      RANGE: 'Orders!A:N',
      WEAPONS_RANGE: 'Weapons!A:M',
      API_KEY: 'AIzaSyAHPBwiyIDWOa5nrewQJDOOq_9wlHe3Bsc'
    };

    // Weapon data cache
    window.weaponData = null;
    window.weaponPriceData = null;
    window.lastWeaponDataUpdate = null;

    // Fetch weapon data from Google Apps Script (secure method)
    async function fetchWeaponData() {
      try {
        console.log('Fetching weapon data from Google Apps Script...');
        const url = window.GOOGLE_SHEETS_CONFIG.APPS_SCRIPT_URL;

        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (!data || !data.success) {
          throw new Error('Apps Script returned error: ' + (data.error || 'Unknown error'));
        }

        if (!data.data || !data.data.weapons || data.data.weapons.length < 2) {
          throw new Error('No weapon data found in response');
        }

        // Parse the data (skip header row)
        const weaponPrices = {};
        const weaponData = data.data.weapons;

        // New column structure: A=Name, B=Category, C=Variant, D=Stock, E=Universal, F=DamageType, G=Magazine, H=FireRate, I=Range, J=Manufacturer, K=ListingImage, L=Spacer, M=BuyPrice
        for (let i = 1; i < weaponData.length; i++) {
          const row = weaponData[i];
          if (row.length < 5) continue; // Skip incomplete rows

          const name = row[0];
          const category = row[1];
          const variant = row[2];
          const stock = parseInt(row[3]) || 0;
          const isUniversal = row[4] === true || row[4] === 'TRUE' || row[4] === 'true';
          const buyPrice = parseInt(row[12]) || 0;

          // Create weapon key
          const weaponKey = `${name}`;

          if (!weaponPrices[weaponKey]) {
            weaponPrices[weaponKey] = {
              name: name,
              category: category,
              variants: {},
              totalStock: 0
            };
          }

          // Add variant data
          weaponPrices[weaponKey].variants[variant] = {
            stock: stock,
            isUniversal: isUniversal,
            buyPrice: buyPrice,
            sellPrice: buyPrice,
            averagePrice: buyPrice
          };

          // Add to total stock if available (or if universal)
          if (isUniversal) {
            weaponPrices[weaponKey].totalStock = 999999; // Unlimited
          } else if (stock > 0) {
            weaponPrices[weaponKey].totalStock += stock;
          }
        }

        window.weaponPriceData = weaponPrices;
        window.lastWeaponDataUpdate = new Date();

        console.log('Weapon data loaded:', Object.keys(weaponPrices).length, 'weapons');
        console.log('Sample weapon data:', weaponPrices[Object.keys(weaponPrices)[0]]);

        // Update price display
        updatePriceUpdateDate();

        return weaponPrices;

      } catch (error) {
        console.error('Error fetching weapon data:', error);
        showToast('Failed to load weapon prices from Google Sheets', 'error');
        return null;
      }
    }

    // Update the price update date display
    function updatePriceUpdateDate() {
      const dateElement = document.getElementById('price-update-date');
      if (dateElement && window.lastWeaponDataUpdate) {
        dateElement.textContent = window.lastWeaponDataUpdate.toLocaleDateString();
      }
    }

    // Get weapon price and stock data
    function getWeaponData(weaponName, variant = null) {
      if (!window.weaponPriceData) {
        return null;
      }

      // Clean the weapon name - remove common suffixes like "LMG", "SMG", "Rifle", etc.
      const cleanWeaponName = weaponName
        .replace(/\s+(LMG|SMG|Rifle|Pistol|Shotgun|Sniper Rifle|Marksman Rifle|Assault Rifle|Submachine Gun|Light Machine Gun)$/i, '')
        .trim();

      // Try exact match with cleaned name first
      let weaponData = window.weaponPriceData[cleanWeaponName];

      // If not found, try exact match with original name
      if (!weaponData) {
        weaponData = window.weaponPriceData[weaponName];
      }

      // If still not found, try partial matches
      if (!weaponData) {
        const keys = Object.keys(window.weaponPriceData);
        const matchingKey = keys.find(key =>
          key.toLowerCase().includes(cleanWeaponName.toLowerCase()) ||
          cleanWeaponName.toLowerCase().includes(key.toLowerCase()) ||
          key.toLowerCase().includes(weaponName.toLowerCase()) ||
          weaponName.toLowerCase().includes(key.toLowerCase())
        );

        if (matchingKey) {
          weaponData = window.weaponPriceData[matchingKey];
        }
      }

      if (!weaponData) {
        return null;
      }

      // If specific variant requested, return that variant's data
      if (variant) {
        const variantData = weaponData.variants[variant] || weaponData.variants['Stock'] || weaponData.variants['Default'];

        if (!variantData) {
          return null;
        }

        return {
          name: weaponData.name,
          type: weaponData.type,
          totalStock: weaponData.totalStock,
          variant: {
            name: variant,
            stock: variantData.stock,
            buyInGame: variantData.buyInGame,
            sellPrice: variantData.sellPrice,
            averagePrice: variantData.averagePrice,
            buyPrice: variantData.buyPrice
          }
        };
      }

      // Return all weapon data including all variants
      return {
        name: weaponData.name,
        type: weaponData.type,
        totalStock: weaponData.totalStock,
        variants: weaponData.variants
      };
    }

    // Format price for display
    function formatPrice(price) {
      if (!price || price === 0) {
        return 'Contact for Price';
      }
      return `${price.toLocaleString()} aUEC`;
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast-notification');
      const messageElement = document.getElementById('toast-message');

      if (toast && messageElement) {
        messageElement.textContent = message;

        // Update styling based on type
        if (type === 'error') {
          toast.style.backgroundColor = '#aa0000';
          toast.style.color = 'white';
        } else {
          toast.style.backgroundColor = '#D3AF37';
          toast.style.color = '#141414';
        }

        // Show toast
        toast.style.transform = 'translateX(0)';

        // Hide after 3 seconds
        setTimeout(() => {
          toast.style.transform = 'translateX(100%)';
        }, 3000);
      }
    }

    // Get stock for specific weapon variant
    function getVariantStock(weaponName, variantName) {
      const weaponData = getWeaponData(weaponName);
      if (!weaponData || !weaponData.variants) {
        return null;
      }

      // Clean variant name (remove price part if present)
      const cleanVariantName = variantName.split(' - ')[0].trim();

      const variantData = weaponData.variants[cleanVariantName];
      if (!variantData) {
        return null;
      }

      // If Universal is true, return unlimited (return a very large number)
      if (variantData.isUniversal) {
        return 999999; // Effectively unlimited
      }

      return variantData.stock;
    }

    // Validate quantity input against variant stock
    function validateQuantity(input) {
      const weaponName = input.getAttribute('data-weapon-name');
      const variantSelect = input.parentElement.parentElement.querySelector('.variant-select');
      const selectedVariant = variantSelect ? variantSelect.value : 'Stock';

      const variantStock = getVariantStock(weaponName, selectedVariant);
      const requestedQuantity = parseInt(input.value) || 1;

      if (variantStock !== null && requestedQuantity > variantStock) {
        input.value = variantStock;
        input.style.borderColor = '#ff0000';
        showToast(`Only ${variantStock} ${weaponName} (${selectedVariant.split(' - ')[0]}) in stock!`, 'error');

        // Reset border color after 3 seconds
        setTimeout(() => {
          input.style.borderColor = '#D3AF37';
        }, 3000);
      } else {
        input.style.borderColor = '#D3AF37';
      }
    }

    // Update quantity max when variant changes
    function updateQuantityMax(weaponName, variantSelect, quantityInput) {
      const selectedVariant = variantSelect.value;
      const variantStock = getVariantStock(weaponName, selectedVariant);

      if (variantStock !== null) {
        quantityInput.max = variantStock;

        // If current quantity exceeds new max, reduce it
        if (parseInt(quantityInput.value) > variantStock) {
          quantityInput.value = variantStock;
        }
      }
    }

    // Validate entire cart against current stock levels
    function validateCartStock() {
      const stockIssues = [];

      for (let i = 0; i < cart.length; i++) {
        const item = cart[i];
        const variantStock = getVariantStock(item.name, item.variant);

        if (variantStock !== null && item.quantity > variantStock) {
          stockIssues.push({
            index: i,
            item: item,
            availableStock: variantStock,
            requestedQuantity: item.quantity
          });
        }
      }

      return stockIssues;
    }

    // Fix cart stock issues automatically
    function fixCartStockIssues() {
      const stockIssues = validateCartStock();
      let fixedItems = [];

      for (const issue of stockIssues) {
        const oldQuantity = issue.item.quantity;
        cart[issue.index].quantity = issue.availableStock;

        fixedItems.push(`${issue.item.name} (${issue.item.variant}): ${oldQuantity} ‚Üí ${issue.availableStock}`);
      }

      if (fixedItems.length > 0) {
        updateCartCount();
        renderCartSidebar();
        showToast(`üîß Fixed stock issues:\n${fixedItems.join('\n')}`, 'error');
        return true;
      }

      return false;
    }

    // Get dynamic price for Specialist Medrunner Loadout variants
    function getMedrunnerLoadoutPrice(variantName) {
      const weaponMapping = {
        'Scout': 'P8-SC',
        'Shotgun': 'BR-2',
        'Heavy': 'FS-9',
        'Marksman': 'P8-AR',
        'Sniper': 'P6-LR'
      };

      const weaponName = weaponMapping[variantName];
      if (!weaponName) {
        return 20000; // Base price if weapon not found
      }

      // Get weapon data from Google Sheets
      const weaponData = getWeaponData(weaponName);
      if (weaponData && weaponData.variants) {
        // Get the Stock variant price (or first available variant)
        const stockVariant = weaponData.variants['Stock'] || Object.values(weaponData.variants)[0];
        if (stockVariant) {
          const weaponPrice = stockVariant.averagePrice || stockVariant.sellPrice || 0;
          return weaponPrice + 20000; // Weapon price + 20,000 aUEC
        }
      }

      // Fallback to hardcoded prices if Google Sheets data not available
      const fallbackPrices = {
        'Scout': 23300,    // P8-SC (3,300) + 20,000
        'Shotgun': 26000,  // BR-2 (6,000) + 20,000
        'Heavy': 40000,    // FS-9 (20,000) + 20,000
        'Marksman': 520000, // P8-AR (500,000) + 20,000
        'Sniper': 320000   // P6-LR (300,000) + 20,000
      };

      return fallbackPrices[variantName] || 20000;
    }

    // Update Medrunner Loadout pricing dynamically
    function updateMedrunnerLoadoutPricing() {
      const medrunnerSelect = document.querySelector('#medrunner-variant-select');
      const medrunnerPriceDisplay = document.querySelector('#medrunner-price-display');

      if (medrunnerSelect && medrunnerPriceDisplay) {
        // Update all options with dynamic pricing
        const variants = ['Scout', 'Shotgun', 'Heavy', 'Marksman', 'Sniper'];
        let minPrice = Infinity;
        let maxPrice = 0;

        medrunnerSelect.innerHTML = '';

        variants.forEach(variant => {
          const price = getMedrunnerLoadoutPrice(variant);
          const formattedPrice = formatPrice(price);

          minPrice = Math.min(minPrice, price);
          maxPrice = Math.max(maxPrice, price);

          const option = document.createElement('option');
          option.value = `${variant} - ${formattedPrice}`;
          option.textContent = `${variant} - ${formattedPrice}`;
          medrunnerSelect.appendChild(option);
        });

        // Update price range display
        medrunnerPriceDisplay.innerHTML = `
          <span class="text-xl font-light text-white">${formatPrice(minPrice)} - ${formatPrice(maxPrice)}</span>
          <span class="text-sm font-light text-gray-400 ml-2">Depending on loadout</span>
        `;
      }
    }

    // Update stock levels after purchase (DISABLED FOR TESTING)
    async function updateWeaponStock(weaponName, variant, quantityPurchased) {
      // DISABLED: Stock updates disabled for testing purposes
      console.log(`Stock update DISABLED for testing: ${weaponName} (${variant}) - ${quantityPurchased} units`);

      // Note: When ready for production, uncomment the code below to enable automatic stock updates
      /*
      try {
        // This would require a new endpoint in your Google Apps Script
        // For now, we'll just refresh the data to get updated stock levels
        console.log(`Stock update needed: ${weaponName} (${variant}) - ${quantityPurchased} units`);

        // Refresh weapon data after a short delay to allow for processing
        setTimeout(async () => {
          await fetchWeaponData();
          // Re-render weapons with updated data
          Object.values(categoryGrids).forEach(grid => {
            if (grid) grid.innerHTML = '';
          });
          renderWeapons();

          // Update Medrunner Loadout pricing after weapon data refresh
          updateMedrunnerLoadoutPricing();
        }, 2000);

      } catch (error) {
        console.error('Error updating weapon stock:', error);
      }
      */
    }

    // Random MOTD (Message of the Day) system
    const motdMessages = [
      "We won't judge you for buying big guns here",
      "For when diplomacy fails",
      "Because sometimes you need more than harsh language",
      "Turning conversations into negotiations since 2952",
      "Where 'peaceful resolution' means bigger weapons",
      "Making sure you're never outgunned",
      "Your one-stop shop for attitude adjustments",
      "Bringing balance to the universe, one weapon at a time",
      "For pilots who prefer to speak softly and carry big guns",
      "Where firepower meets finesse",
      "Because sometimes you need to make a statement",
      "Helping you win arguments since the 30th century"
    ];

    function setRandomMOTD() {
      const motdElement = document.getElementById('motd-text');
      if (motdElement) {
        const randomIndex = Math.floor(Math.random() * motdMessages.length);
        motdElement.textContent = motdMessages[randomIndex];
      }
    }

    // Loading messages for the loading screen
    const loadingMessages = [
      "Reloading Weapons...",
      "Polishing Barrels...",
      "Polishing Armor...",
      "Calibrating Scopes...",
      "Counting Ammo...",
      "Checking Inventory...",
      "Oiling Mechanisms...",
      "Testing Triggers...",
      "Recharging Batteries...",
      "Organizing Arsenal...",
      "Dusting Off Shelves...",
      "Checking Quality...",
      "Restocking Shelves...",
      "Locking and Loading...",
      "Filing Down Serial Numbers...",
      "Forgetting We Ever Saw You...",
      "Checking for Wiretaps...",
      "Generating an Alibi..."
    ];

    function setRandomLoadingMessage() {
      const loadingText = document.querySelector('.loading-text');
      if (loadingText) {
        const randomIndex = Math.floor(Math.random() * loadingMessages.length);
        loadingText.textContent = loadingMessages[randomIndex];
      }
    }

    // Generate starfield for loading screen
    function generateStarfield() {
      const starfield = document.getElementById('starfield');
      if (!starfield) return;

      for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        starfield.appendChild(star);
      }
    }

    // Initialize weapon data on page load
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Page loaded, fetching weapon listings from Google Sheets...');

      // Generate starfield for loading screen
      generateStarfield();

      // Show loading screen
      showLoadingScreen();

      // Set random loading message
      setRandomLoadingMessage();

      // Set random MOTD on page load
      setRandomMOTD();

      // Create a timeout failsafe - if loading takes more than 20 seconds, show error and continue
      const loadingTimeout = setTimeout(() => {
        console.error('Loading timeout: Weapon data took too long to load');
        hideLoadingScreen();
        showToast('‚ö†Ô∏è Failed to load inventory, please try again later.', 'error');
      }, 20000);

      try {
        // Fetch active weapon listings from Google Sheets
        await fetchWeaponListings();

        // Clear the timeout since loading succeeded
        clearTimeout(loadingTimeout);

        // Clear existing weapon grids and re-render with updated data
        Object.values(categoryGrids).forEach(grid => {
          if (grid) grid.innerHTML = '';
        });
        renderWeapons();

        // Update Medrunner Loadout pricing
        updateMedrunnerLoadoutPricing();

        // Hide loading screen after data is loaded
        hideLoadingScreen();
      } catch (error) {
        console.error('Error during initialization:', error);
        clearTimeout(loadingTimeout);
        hideLoadingScreen();
        showToast('‚ùå Error loading inventory: ' + error.message, 'error');
      }

      // Refresh weapon listings every 5 minutes
      setInterval(async () => {
        await fetchWeaponListings();
        // Re-render weapons with updated data
        Object.values(categoryGrids).forEach(grid => {
          if (grid) grid.innerHTML = '';
        });
        renderWeapons();

        // Update Medrunner Loadout pricing after data refresh
        updateMedrunnerLoadoutPricing();
      }, 5 * 60 * 1000);
    });

    window.weaponDataLoaded = false;

    function openImage(src) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modalImg.src = src;
      modal.classList.remove('hidden');
    }

    document.getElementById('imageModal').addEventListener('click', () => {
      document.getElementById('imageModal').classList.add('hidden');
    });

    function toggleDetails(button) {
      const details = button.parentElement.parentElement.querySelector('.details');
      details.classList.toggle('hidden');
    }

    // Cart functionality
    let cart = [];
    let orderProcessing = false; // Flag to prevent cart closure during order processing

    function updateCartCount() {
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartCountElement = document.getElementById('cart-count');
      if (cartCountElement) {
        cartCountElement.textContent = totalItems;
      }
    }

    function addToCart(name, fullName, button) {
      console.log('addToCart called with:', name, fullName);
      const card = button.closest('.p-card');
      console.log('Found card:', card);
      const variantSelect = card.querySelector('.variant-select');
      const quantityInput = card.querySelector('.quantity-input');
      console.log('Found variant select:', variantSelect);
      console.log('Found quantity input:', quantityInput);

      if (!variantSelect || !quantityInput) {
        console.error('Could not find variant select or quantity input');
        console.error('Card HTML:', card ? card.innerHTML : 'No card found');
        return;
      }

      const variant = variantSelect.value;
      let quantity = parseInt(quantityInput.value);
      console.log('Variant:', variant);
      console.log('Quantity:', quantity);

      // Security: Validate quantity is positive integer
      if (!quantity || quantity < 1 || quantity > 100 || !Number.isInteger(quantity)) {
        console.error('Invalid quantity:', quantity);
        showToast('Invalid quantity. Must be a positive number between 1 and 100.', 'error');
        quantityInput.value = 1;
        return;
      }

      // Security: Validate variant is selected
      if (!variant) {
        console.error('No variant selected');
        showToast('Error: Please select a variant', 'error');
        return;
      }

      // Check if this is a kit (kits have isKit flag)
      const weaponData = weapons.find(w => w.name === name);
      const isKit = weaponData && weaponData.isKit;

      // Handle variant format - could be just "Stock" or "Stock - Price aUEC"
      let variantName = variant;
      let price = '';

      if (isKit) {
        // For kits, use a simple format
        variantName = 'Default';
        price = '0 aUEC'; // Kits don't have individual pricing
      } else if (variant.includes(' - ')) {
        const [vName, vPrice] = variant.split(' - ');
        variantName = vName;
        price = vPrice;
      } else {
        // If variant is just the name, look up the price from weapon data
        if (weaponData && weaponData.allVariants && weaponData.allVariants[variant]) {
          const variantInfo = weaponData.allVariants[variant];
          price = variantInfo.buyPrice ? variantInfo.buyPrice + ' aUEC' : '0 aUEC';
        } else {
          console.error('Could not find variant data for:', variant);
          showToast('Error: Could not find variant price', 'error');
          return;
        }
      }

      // Security: Validate price format
      const priceNumber = parseInt(price.replace(/[^0-9]/g, ''));
      if (isNaN(priceNumber) || priceNumber < 0) {
        console.error('Invalid price:', price);
        showToast('Error: Invalid price detected', 'error');
        return;
      }

      // Check variant stock before adding to cart (skip for kits)
      if (!isKit) {
        const variantStock = getVariantStock(name, variantName);
        const existingItem = cart.find(item => item.name === name && item.variant === variantName);
        const currentCartQuantity = existingItem ? existingItem.quantity : 0;
        const totalRequestedQuantity = currentCartQuantity + quantity;

        if (variantStock !== null && totalRequestedQuantity > variantStock) {
          const availableQuantity = Math.max(0, variantStock - currentCartQuantity);

          if (availableQuantity === 0) {
            showToast(`‚ùå ${name} (${variantName}) is already at maximum stock in your cart!`, 'error');
            return;
          } else {
            showToast(`‚ö†Ô∏è Only ${availableQuantity} more ${name} (${variantName}) available. Adding ${availableQuantity} instead of ${quantity}.`, 'error');
            quantityInput.value = availableQuantity;
            quantity = availableQuantity;
          }
        }
      }

      const existingItem = cart.find(item => item.name === name && item.variant === variantName);
      if (existingItem) {
        existingItem.quantity += quantity;
      } else {
        cart.push({
          name: sanitizeInput(name),
          fullName: sanitizeInput(fullName),
          variant: sanitizeInput(variantName),
          price,
          quantity
        });
      }

      updateCartCount();
      renderCartSidebar();
      showToast(`Added ${quantity}x ${name} to cart!`);
    }

    // Add kit to cart (simplified - no variants or quantity selection)
    function addKitToCart(name, button) {
      console.log('addKitToCart called with:', name);

      // Check if kit already in cart
      const existingItem = cart.find(item => item.name === name);
      if (existingItem) {
        showToast(`${name} is already in your cart!`, 'error');
        return;
      }

      // Add kit to cart with quantity 1
      cart.push({
        name: sanitizeInput(name),
        fullName: sanitizeInput(name),
        variant: 'Default',
        price: '0 aUEC',
        quantity: 1
      });

      updateCartCount();
      renderCartSidebar();
      showToast(`Added ${name} to cart!`);
    }

    // Security: Input sanitization function
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.trim().substring(0, 100).replace(/[<>\"'&]/g, '');
    }

    // Security: Discord username validation
    function validateDiscordUsername(username) {
      if (!username || typeof username !== 'string') {
        return false;
      }

      // Discord usernames: 2-32 characters, letters, numbers, underscores, periods
      // Must contain at least one letter (cannot be only numbers)
      const discordRegex = /^[a-zA-Z0-9_.]{2,32}$/;
      const hasLetter = /[a-zA-Z]/;

      return discordRegex.test(username) && hasLetter.test(username);
    }

    // Order Success Modal Functions
    function showOrderSuccessModal(orderId, message) {
      const modal = document.getElementById('order-success-modal');
      const orderIdElement = document.getElementById('modal-order-id');
      const messageElement = document.getElementById('modal-message');

      // Update modal content
      orderIdElement.textContent = `ORDER ID: ${orderId}`;
      messageElement.innerHTML = message.replace(/\n/g, '<br>');

      // Show modal
      modal.classList.remove('hidden');

      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeOrderModal() {
      const modal = document.getElementById('order-success-modal');
      modal.classList.add('hidden');

      // Restore body scroll
      document.body.style.overflow = '';
    }

    function downloadReceipt() {
      if (!window.orderReceiptData) {
        alert('Receipt data not available');
        return;
      }

      const { fullReceipt, orderId, discordUsername } = window.orderReceiptData;

      // Create and download receipt file
      const blob = new Blob([fullReceipt], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `seraph-armory-order-${discordUsername}-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      // Close modal after download
      closeOrderModal();
    }

    function goToTracking() {
      // Close modal first
      closeOrderModal();

      // Navigate to order status page
      window.location.href = 'order-status.html';
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartCount();
      renderCartSidebar();
    }

    function updateQuantity(index, newQuantity) {
      if (newQuantity <= 0) {
        removeFromCart(index);
      } else {
        const item = cart[index];
        const variantStock = getVariantStock(item.name, item.variant);

        // Validate against stock
        if (variantStock !== null && newQuantity > variantStock) {
          showToast(`‚ùå Only ${variantStock} ${item.name} (${item.variant}) in stock!`, 'error');
          cart[index].quantity = variantStock;
        } else {
          cart[index].quantity = newQuantity;
        }

        updateCartCount();
        renderCartSidebar();
      }
    }

    function parsePrice(priceStr) {
      // Handle "Free" items
      if (priceStr.toLowerCase().includes('free')) {
        return 0;
      }
      const parsed = parseInt(priceStr.replace(/[^\d]/g, ''));
      return isNaN(parsed) ? 0 : parsed;
    }

    function formatPrice(price) {
      return price.toLocaleString() + ' aUEC';
    }

    function calculateTotal() {
      const subtotal = cart.reduce((sum, item) => {
        const itemPrice = parsePrice(item.price);
        return sum + (itemPrice * item.quantity);
      }, 0);

      // No delivery tax - all orders collected from Seraphim Station
      const total = subtotal;

      return { subtotal, deliveryTax: 0, total };
    }

    function renderCartSidebar() {
      const cartItems = document.getElementById('cart-items-sidebar');
      const cartSubtotal = document.getElementById('cart-subtotal');
      const cartTotal = document.getElementById('cart-total-sidebar');

      if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-gray-400 text-center py-8">Your cart is empty</p>';
        if (cartSubtotal) cartSubtotal.textContent = '0 aUEC';
        if (cartTotal) cartTotal.textContent = '0 aUEC';
        return;
      }

      cartItems.innerHTML = cart.map((item, index) => {
        const itemPrice = parsePrice(item.price);
        const itemTotal = itemPrice * item.quantity;
        const variantStock = getVariantStock(item.name, item.variant);

        // Check if quantity exceeds stock
        const isOverStock = variantStock !== null && item.quantity > variantStock;
        const stockWarning = isOverStock ? `‚ö†Ô∏è Only ${variantStock} in stock!` : '';
        const stockInfo = variantStock !== null ? `(${variantStock} available)` : '';

        return `
          <div class="bg-gray-700 p-3 rounded-lg ${isOverStock ? 'border border-red-500' : ''}">
            <div class="mb-2">
              <h3 class="font-bold text-sm">${item.name}</h3>
              <p class="text-xs text-gray-300">${item.fullName}</p>
              <p class="text-xs">Variant: ${item.variant} ${stockInfo}</p>
              <p class="text-xs">Price: ${item.price}</p>
              ${stockWarning ? `<p class="text-xs text-red-400">${stockWarning}</p>` : ''}
            </div>
            <div class="flex justify-between items-center">
              <div class="flex items-center space-x-2">
                <button onclick="updateQuantity(${index}, ${item.quantity - 1})" class="bg-red-600 px-2 py-1 rounded hover:bg-red-500 text-xs">-</button>
                <span class="text-sm ${isOverStock ? 'text-red-400' : ''}">${item.quantity}</span>
                <button onclick="updateQuantity(${index}, ${item.quantity + 1})" class="bg-green-600 px-2 py-1 rounded hover:bg-green-500 text-xs" ${variantStock !== null && item.quantity >= variantStock ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>+</button>
              </div>
              <div class="text-right">
                <p class="font-semibold text-sm">${formatPrice(itemTotal)}</p>
                <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-300 text-xs">Remove</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      const totals = calculateTotal();
      if (cartSubtotal) cartSubtotal.textContent = formatPrice(totals.subtotal);
      if (cartTotal) cartTotal.textContent = formatPrice(totals.total);
    }

    function toggleCart() {
      // Prevent cart closure during order processing
      if (orderProcessing) {
        alert('‚è≥ Please wait while your order is being processed. The cart will close automatically when complete.');
        return;
      }

      const sidebar = document.getElementById('cart-sidebar');
      const overlay = document.getElementById('cart-overlay');

      if (sidebar.classList.contains('translate-x-full')) {
        sidebar.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');
        renderCartSidebar();
      } else {
        sidebar.classList.add('translate-x-full');
        overlay.classList.add('hidden');
      }
    }

    async function checkout() {
      if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }

      // Validate stock levels before proceeding
      const stockIssues = validateCartStock();
      if (stockIssues.length > 0) {
        const issueMessages = stockIssues.map(issue =>
          `‚Ä¢ ${issue.item.name} (${issue.item.variant}): Requesting ${issue.requestedQuantity}, only ${issue.availableStock} available`
        );

        const userChoice = confirm(
          `‚ö†Ô∏è STOCK ISSUES DETECTED:\n\n${issueMessages.join('\n')}\n\n` +
          `Click OK to automatically fix these issues and continue checkout.\n` +
          `Click Cancel to review your cart manually.`
        );

        if (userChoice) {
          fixCartStockIssues();
          // Continue with checkout after fixing issues
        } else {
          showToast('Please review your cart and adjust quantities.', 'error');
          return;
        }
      }

      // Clear any previous error highlighting
      document.getElementById('discord-username').style.borderColor = '#D3AF37';

      // Validate required fields
      const discordUsername = document.getElementById('discord-username');

      let hasErrors = false;

      if (!discordUsername || !discordUsername.value.trim()) {
        discordUsername.style.borderColor = '#ff0000';
        hasErrors = true;
      } else if (!validateDiscordUsername(discordUsername.value.trim())) {
        discordUsername.style.borderColor = '#ff0000';
        showToast('Invalid Discord username format. Must be 2-32 characters, letters/numbers/underscore/period, cannot be only numbers.', 'error');
        hasErrors = true;
      }

      if (hasErrors) {
        return;
      }

      const totals = calculateTotal();
      const currentTimestamp = Math.floor(Date.now() / 1000);
      const currentDate = new Date().toLocaleString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      // Generate unique order ID
      const orderId = `SA-${currentTimestamp}`;

      // Create full receipt for file download
      let fullReceipt = `===============================================\n`;
      fullReceipt += `           THE SERAPH ARMORY\n`;
      fullReceipt += `        Star Citizen Equipment Store\n`;
      fullReceipt += `===============================================\n\n`;

      fullReceipt += `RECEIPT FOR: ${discordUsername.value.trim()}\n`;
      fullReceipt += `ORDER ID: ${orderId}\n`;
      fullReceipt += `DATE: ${currentDate}\n`;
      fullReceipt += `STATUS: Received\n\n`;

      fullReceipt += `-----------------------------------------------\n`;
      fullReceipt += `PURCHASED ITEMS:\n`;
      fullReceipt += `-----------------------------------------------\n`;

      cart.forEach((item, index) => {
        const itemPrice = parsePrice(item.price);
        const itemTotal = itemPrice * item.quantity;

        fullReceipt += `${index + 1}. ${item.name}`;
        if (item.variant && item.variant !== 'Default') {
          fullReceipt += ` (${item.variant})`;
        }
        fullReceipt += `\n`;
        fullReceipt += `   Quantity: ${item.quantity}\n`;
        fullReceipt += `   Unit Price: ${formatPrice(itemPrice)}\n`;
        fullReceipt += `   Item Total: ${formatPrice(itemTotal)}\n\n`;
      });

      fullReceipt += `-----------------------------------------------\n`;
      fullReceipt += `TRANSACTION SUMMARY:\n`;
      fullReceipt += `-----------------------------------------------\n`;
      fullReceipt += `Subtotal:        ${formatPrice(totals.subtotal)}\n`;
      fullReceipt += `-----------------------------------------------\n`;
      fullReceipt += `TOTAL AMOUNT:    ${formatPrice(totals.total)}\n`;
      fullReceipt += `-----------------------------------------------\n\n`;

      fullReceipt += `ORDER STATUS:\n`;
      fullReceipt += `Payment Received: [ ] Pending\n`;
      fullReceipt += `Items Ready:      [ ] Pending\n\n`;

      // Get selected pickup location
      const pickupLocation = document.getElementById('pickup-location').value || 'Seraphim Station';

      fullReceipt += `FULFILLMENT METHOD: Collection\n`;
      fullReceipt += `PICKUP LOCATION: ${pickupLocation}\n`;

      fullReceipt += `\n===============================================\n`;
      fullReceipt += `Thank you for choosing The Seraph Armory!\n\n`;
      fullReceipt += `IMPORTANT:\n`;
      fullReceipt += `- Keep this receipt for your records\n`;
      fullReceipt += `- Use Order ID to track your order status\n`;
      fullReceipt += `- Contact us on Discord for any questions\n`;
      fullReceipt += `===============================================\n`;

      // Create simple user confirmation message for modal
      let userMessage = `Order Total: ${formatPrice(totals.total)}\n`;
      userMessage += `Fulfillment: Collection from ${pickupLocation}\n\n`;
      userMessage += `We will contact you once your order is ready to be collected, you can track its status in the meantime by going to order status and entering your Order ID`;

      // Store receipt data for modal
      window.orderReceiptData = {
        fullReceipt: fullReceipt,
        orderId: orderId,
        discordUsername: discordUsername.value.trim()
      };

      // Set processing flag to prevent cart closure
      orderProcessing = true;

      // Disable checkout button and show loading state
      const checkoutButton = document.querySelector('button[onclick="checkout()"]');
      const originalButtonText = checkoutButton.innerHTML;
      checkoutButton.innerHTML = '‚è≥ Processing Order...';
      checkoutButton.disabled = true;

      // Show processing status
      const statusDiv = document.getElementById('sheets-status');
      const statusText = document.getElementById('sheets-status-text');
      if (statusDiv && statusText) {
        statusDiv.classList.remove('hidden');
        statusText.textContent = 'üì§ Uploading order to management system...';
        statusText.style.backgroundColor = '#3b82f6';
        statusText.style.color = '#fff';
      }

      // Upload to Google Sheets FIRST (before receipt download)
      let uploadSuccess = false;
      let retryCount = 0;
      const maxRetries = 3;

      while (!uploadSuccess && retryCount < maxRetries) {
        try {
          await sendToGoogleSheets({
            orderId: orderId,
            timestamp: currentTimestamp,
            date: currentDate,
            discordUsername: discordUsername.value.trim(),
            fulfillmentMethod: 'Collection',
            deliveryLocation: pickupLocation,
            subtotal: totals.subtotal,
            deliveryTax: 0,
            total: totals.total,
            items: cart.map(item => ({
              name: item.name,
              fullName: item.fullName,
              variant: item.variant,
              price: item.price,
              quantity: item.quantity,
              itemTotal: parsePrice(item.price) * item.quantity
            })),
            status: 'Received',
            paymentReceived: false,
            itemTransferred: false
          });

          uploadSuccess = true;

          // Show success status
          if (statusDiv && statusText) {
            statusText.textContent = '‚úîÔ∏è Order successfully uploaded!';
            statusText.style.backgroundColor = '#10b981';
            statusText.style.color = '#fff';
          }

        } catch (error) {
          console.error(`Upload attempt ${retryCount + 1} failed:`, error);

          // Check if this is a CORS error (which actually means the request succeeded)
          const isCorsError = error.message && (
            error.message.includes('NetworkError') ||
            error.message.includes('CORS') ||
            error.message.includes('Cross-Origin') ||
            error.name === 'TypeError'
          );

          if (isCorsError) {
            // CORS error usually means the request succeeded but browser blocked reading response
            console.log('CORS error detected - treating as successful upload since data likely reached server');
            uploadSuccess = true;

            // Show success status
            if (statusDiv && statusText) {
              statusText.textContent = '‚úîÔ∏è Order successfully uploaded!';
              statusText.style.backgroundColor = '#10b981';
              statusText.style.color = '#fff';
            }
            break; // Exit retry loop
          }

          retryCount++;

          if (retryCount < maxRetries) {
            // Show retry status for non-CORS errors
            if (statusDiv && statusText) {
              statusText.textContent = `üîÑ Upload failed, retrying... (${retryCount}/${maxRetries})`;
              statusText.style.backgroundColor = '#f59e0b';
              statusText.style.color = '#000';
            }
            // Wait 1 second before retry
            await new Promise(resolve => setTimeout(resolve, 1000));
          } else {
            // All retries failed for real errors
            if (statusDiv && statusText) {
              statusText.textContent = '‚ùå Upload failed after 3 attempts. Please contact support.';
              statusText.style.backgroundColor = '#ef4444';
              statusText.style.color = '#fff';
            }

            // Re-enable checkout button and clear processing flag
            checkoutButton.innerHTML = originalButtonText;
            checkoutButton.disabled = false;
            orderProcessing = false;

            alert('‚ùå Failed to upload order to management system after multiple attempts.\n\nPlease try again or contact support if the issue persists.\n\nYour order has NOT been processed.');
            return; // Exit without clearing cart or downloading receipt
          }
        }
      }

      // Only proceed with receipt download and cart clearing if upload was successful
      if (uploadSuccess) {
        // Update status to show receipt generation
        if (statusDiv && statusText) {
          statusText.textContent = 'üìÑ Generating receipt...';
          statusText.style.backgroundColor = '#3b82f6';
          statusText.style.color = '#fff';
        }

        // Show order success modal instead of alert
        showOrderSuccessModal(orderId, userMessage);

        // Clear cart and reset form
        cart = [];
        updateCartCount();
        renderCartSidebar();

        // Reset form
        if (discordUsername) discordUsername.value = '';

        // Re-enable checkout button and clear processing flag
        checkoutButton.innerHTML = originalButtonText;
        checkoutButton.disabled = false;
        orderProcessing = false;

        // Show final success status
        if (statusDiv && statusText) {
          statusText.textContent = '‚úîÔ∏è Order completed successfully!';
          statusText.style.backgroundColor = '#10b981';
          statusText.style.color = '#fff';

          // Hide status after 3 seconds and close cart
          setTimeout(() => {
            statusDiv.classList.add('hidden');
            toggleCart(); // Close cart only after everything is complete
          }, 3000);
        }
      }
    }
    function addBundleToCart(name, price, button) {
      const card = button.closest('.p-card');
      const variantSelect = card.querySelector('.variant-select');
      const quantityInput = card.querySelector('.quantity-input');
      
      const variant = variantSelect ? variantSelect.value : 'Default - Free';
      const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
      
      const [variantName, variantPrice] = variant.split(' - ');
      const actualPrice = variantPrice;
      
      const existingItem = cart.find(item => item.name === name && item.variant === variantName);
      
      if (existingItem) {
        existingItem.quantity += quantity;
      } else {
        cart.push({
          name,
          fullName: name,
          variant: variantName,
          price: actualPrice,
          quantity
        });
      }
      
      updateCartCount();
      renderCartSidebar();
      showToast(`Added ${quantity}x ${name} (${variantName}) to cart!`);
    }

    function showToast(message) {
      const toast = document.getElementById('toast-notification');
      const toastMessage = document.getElementById('toast-message');
      
      toastMessage.textContent = message;
      toast.classList.remove('translate-x-full');
      
      setTimeout(() => {
        toast.classList.add('translate-x-full');
      }, 3000);
    }

    // Initialize cart count on page load
    document.addEventListener('DOMContentLoaded', updateCartCount);

    // Convert Unix timestamp to readable date
    document.addEventListener('DOMContentLoaded', function() {
      const timestamp = 1761174000; // Your Unix timestamp
      const date = new Date(timestamp * 1000);
      const formattedDate = date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const timeAgo = getTimeAgo(date);
      
      document.getElementById('price-update-date').innerHTML = `${formattedDate} (${timeAgo})`;
    });

    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      const diffInDays = Math.floor(diffInSeconds / (24 * 60 * 60));
      
      if (diffInDays === 0) return 'today';
      if (diffInDays === 1) return '1 day ago';
      return `${diffInDays} days ago`;
    }

    function toggleWeaponsDropdown() {
      const dropdown = document.getElementById('weapons-dropdown');
      dropdown.classList.toggle('hidden');
    }

    // Google Sheets Integration Functions
    function validateGoogleSheetsConfig() {
      if (!window.GOOGLE_SHEETS_CONFIG) {
        throw new Error('Google Sheets configuration not loaded.');
      }

      if (window.GOOGLE_SHEETS_CONFIG.APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
        throw new Error('Google Apps Script URL not configured. Please follow the setup guide.');
      }

      return true;
    }

    async function sendToGoogleSheets(orderData) {
      // Validate Google Sheets configuration
      try {
        validateGoogleSheetsConfig();
      } catch (error) {
        throw new Error(`Configuration Error: ${error.message}`);
      }

      const { APPS_SCRIPT_URL } = window.GOOGLE_SHEETS_CONFIG;

      // Prepare secure order data for server-side validation
      const secureOrderData = {
        action: 'submitOrder',
        orderId: sanitizeInput(orderData.orderId),
        timestamp: orderData.timestamp,
        date: orderData.date,
        discordUsername: sanitizeInput(orderData.discordUsername),
        fulfillmentMethod: sanitizeInput(orderData.fulfillmentMethod),
        deliveryLocation: sanitizeInput(orderData.deliveryLocation),
        subtotal: orderData.subtotal,
        deliveryTax: orderData.deliveryTax,
        total: orderData.total,
        items: orderData.items.map(item => ({
          name: sanitizeInput(item.name),
          fullName: sanitizeInput(item.fullName),
          variant: sanitizeInput(item.variant),
          price: item.price,
          quantity: parseInt(item.quantity)
        })),
        itemCount: orderData.items.length,
        status: 'Received',
        paymentReceived: false,
        itemTransferred: false,
        clientIP: 'web-client' // Apps Script will handle IP detection
      };

      // Send to Google Apps Script with server-side validation
      console.log('Sending secure order to Google Apps Script:', {
        orderId: secureOrderData.orderId,
        timestamp: secureOrderData.timestamp,
        discordUsername: secureOrderData.discordUsername,
        itemCount: secureOrderData.itemCount,
        url: APPS_SCRIPT_URL
      });

      // Build form data for Google Apps Script (avoids CORS preflight)
      const formData = new FormData();
      formData.append('action', secureOrderData.action);
      formData.append('orderId', secureOrderData.orderId);
      formData.append('timestamp', secureOrderData.timestamp);
      formData.append('date', secureOrderData.date);
      formData.append('discordUsername', secureOrderData.discordUsername);
      formData.append('fulfillmentMethod', secureOrderData.fulfillmentMethod);
      formData.append('deliveryLocation', secureOrderData.deliveryLocation);
      formData.append('subtotal', secureOrderData.subtotal);
      formData.append('deliveryTax', secureOrderData.deliveryTax);
      formData.append('total', secureOrderData.total);
      formData.append('items', JSON.stringify(secureOrderData.items));
      formData.append('itemCount', secureOrderData.itemCount);
      formData.append('status', secureOrderData.status);
      formData.append('paymentReceived', secureOrderData.paymentReceived);
      formData.append('itemTransferred', secureOrderData.itemTransferred);
      formData.append('clientIP', secureOrderData.clientIP);

      // Send as POST with form data using no-cors mode
      // This allows the request to go through even from file:// origins
      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: formData,
        mode: 'no-cors'
      });

      console.log('Response status:', response.status, response.statusText);
      console.log('Response type:', response.type);

      // With no-cors mode, we can't read the response, but the request was sent
      // Return a success response assuming the server processed it
      const jsonResult = {
        success: true,
        orderId: secureOrderData.orderId,
        message: 'Order submitted successfully',
        timestamp: new Date().toISOString()
      };

      console.log('Order submitted successfully:', {
        orderId: jsonResult.orderId,
        message: jsonResult.message
      });

      return jsonResult;
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('weapons-dropdown');
      if (!dropdown) return; // Exit if dropdown doesn't exist

      const button = event.target.closest('button');

      if (!button || !button.onclick || button.onclick.toString().indexOf('toggleWeaponsDropdown') === -1) {
        dropdown.classList.add('hidden');
      }
    });

    // Background images
    const backgroundImages = [
      'https://images.hdqwalls.com/wallpapers/star-citizen-2019-4k-ze.jpg',
      'https://images.hdqwalls.com/wallpapers/2023-star-citizen-5k-wu.jpg',
      'https://images.hdqwalls.com/wallpapers/star-citizen-wanderer-4k-f8.jpg',
      'https://images.hdqwalls.com/wallpapers/star-citizen-4k-ad.jpg',
      'https://images.hdqwalls.com/wallpapers/star-citizen-2019-17.jpg',
      'https://www.hasgaha.com/wp-content/uploads/photo-gallery/Star_Citizen/Star_Citizen_Alpha_3.10/.original/SC-3.10_20200824_223738_M50-streaking_f.png'
    ];

    // Randomise
    function setRandomBackground() {
      const randomIndex = Math.floor(Math.random() * backgroundImages.length);
      const heroSection = document.getElementById('hero-section');
      if (heroSection) {
        heroSection.style.backgroundImage = `url('${backgroundImages[randomIndex]}')`;
        heroSection.style.backgroundSize = 'cover';
        heroSection.style.backgroundPosition = 'center';
        heroSection.style.backgroundRepeat = 'no-repeat';
      }
    }

    // On page load
    document.addEventListener('DOMContentLoaded', function() {
      setRandomBackground();
    });


  </script>
</body>
</html>

